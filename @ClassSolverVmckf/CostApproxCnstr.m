function [vec_Cost, mat_Jacobian, cellmat_Hessian] = ...
    CostApproxCnstr(this, struct_cnstr, vec_mu_x, vec_mu_y)
%COSTAPPROXCNSTR to compute the quadratic approximation of constraint.

qx_c_b = vec_mu_x(1); qy_c_b = vec_mu_x(2); qz_c_b = vec_mu_x(3); qw_c_b = vec_mu_x(4);
x_c_b = vec_mu_x(5); y_c_b = vec_mu_x(6);
dt = vec_mu_x(7);
x_b2_b1 = vec_mu_y(1); y_b2_b1 = vec_mu_y(2); theta_b2_b1 = vec_mu_y(3);
x_m_c1 = vec_mu_y(4); y_m_c1 = vec_mu_y(5); z_m_c1 = vec_mu_y(6);
x_m_c2 = vec_mu_y(7); y_m_c2 = vec_mu_y(8); z_m_c2 = vec_mu_y(9);


%% compute Jacobian d(mu_x)/d(mu_x_delay), 15x16 matrix
J_mu_x = zeros(15,16);
J_mu_x(1:6,1:6) = eye(6);
J_mu_x(7:end, 8:end) = eye(9);

ps_w_b1 = struct_cnstr.ps_w_b1;
ps_w_b2 = struct_cnstr.ps_w_b2;
vps_w_b1 = struct_cnstr.vps_w_b1;
vps_w_b2 = struct_cnstr.vps_w_b2;

theta_o_b1 = ps_w_b1(3);
R_temp = ...
    [cos(theta_o_b1) -sin(theta_o_b1) 0;...
    sin(theta_o_b1) cos(theta_o_b1) 0;...
    0 0 1];
dR_temp = ...
    [-sin(theta_o_b1) -cos(theta_o_b1) 0;...
    cos(theta_o_b1) -sin(theta_o_b1) 0;...
    0 0 1];
J_temp = R_temp*(vps_w_b2-vps_w_b1) + dR_temp*(ps_w_b2-ps_w_b1);

J_mu_x(7:9, 7) = J_temp; 


%% for z1
% Hessian
H1 = ...
[                                                                                                                                 2*x_m_c1 - 2*x_m_c2*cos(theta_b2_b1) + 2*y_m_c2*sin(theta_b2_b1),                                                                                                                                                                        2*z_m_c2*sin(theta_b2_b1),                                                                                                                                                             2*z_m_c2*cos(theta_b2_b1) - 2*z_m_c1,                                                                                                                                 2*y_m_c1 - 2*y_m_c2*cos(theta_b2_b1) - 2*x_m_c2*sin(theta_b2_b1),                0,                0, 0, 0,                                                                                                                                                                                                                                                                   y_m_c2*(2*qx_c_b*cos(theta_b2_b1) + 2*qw_c_b*sin(theta_b2_b1)) - x_m_c2*(2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1)) + z_m_c2*(2*qy_c_b*cos(theta_b2_b1) - 2*qz_c_b*sin(theta_b2_b1)),  2*qx_c_b, 2*qw_c_b, -2*qz_c_b,                                                             - 2*qx_c_b*cos(theta_b2_b1) - 2*qw_c_b*sin(theta_b2_b1),                                                               2*qx_c_b*sin(theta_b2_b1) - 2*qw_c_b*cos(theta_b2_b1),                                                                                     2*qz_c_b*cos(theta_b2_b1) + 2*qy_c_b*sin(theta_b2_b1);...
                                                                                                                                                                        2*z_m_c2*sin(theta_b2_b1),                                                                                                                                 2*x_m_c1 - 2*x_m_c2*cos(theta_b2_b1) - 2*y_m_c2*sin(theta_b2_b1),                                                                                                                                 2*y_m_c1 - 2*y_m_c2*cos(theta_b2_b1) + 2*x_m_c2*sin(theta_b2_b1),                                                                                                                                                             2*z_m_c1 - 2*z_m_c2*cos(theta_b2_b1),                0,                0, 0, 0,                                                                                                                                                                                                                                                                   x_m_c2*(2*qz_c_b*cos(theta_b2_b1) + 2*qy_c_b*sin(theta_b2_b1)) - y_m_c2*(2*qy_c_b*cos(theta_b2_b1) - 2*qz_c_b*sin(theta_b2_b1)) + z_m_c2*(2*qx_c_b*cos(theta_b2_b1) + 2*qw_c_b*sin(theta_b2_b1)),  2*qy_c_b, 2*qz_c_b,  2*qw_c_b,                                                               2*qz_c_b*sin(theta_b2_b1) - 2*qy_c_b*cos(theta_b2_b1),                                                             - 2*qz_c_b*cos(theta_b2_b1) - 2*qy_c_b*sin(theta_b2_b1),                                                                                     2*qx_c_b*sin(theta_b2_b1) - 2*qw_c_b*cos(theta_b2_b1);...
                                                                                                                                                             2*z_m_c2*cos(theta_b2_b1) - 2*z_m_c1,                                                                                                                                 2*y_m_c1 - 2*y_m_c2*cos(theta_b2_b1) + 2*x_m_c2*sin(theta_b2_b1),                                                                                                                                 2*x_m_c2*cos(theta_b2_b1) - 2*x_m_c1 + 2*y_m_c2*sin(theta_b2_b1),                                                                                                                                                                        2*z_m_c2*sin(theta_b2_b1),                0,                0, 0, 0,                                                                                                                                                                                                                                                                   x_m_c2*(2*qy_c_b*cos(theta_b2_b1) - 2*qz_c_b*sin(theta_b2_b1)) + y_m_c2*(2*qz_c_b*cos(theta_b2_b1) + 2*qy_c_b*sin(theta_b2_b1)) + z_m_c2*(2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1)), -2*qz_c_b, 2*qy_c_b, -2*qx_c_b,                                                               2*qz_c_b*cos(theta_b2_b1) + 2*qy_c_b*sin(theta_b2_b1),                                                               2*qz_c_b*sin(theta_b2_b1) - 2*qy_c_b*cos(theta_b2_b1),                                                                                     2*qx_c_b*cos(theta_b2_b1) + 2*qw_c_b*sin(theta_b2_b1);...
                                                                                                                                 2*y_m_c1 - 2*y_m_c2*cos(theta_b2_b1) - 2*x_m_c2*sin(theta_b2_b1),                                                                                                                                                             2*z_m_c1 - 2*z_m_c2*cos(theta_b2_b1),                                                                                                                                                                        2*z_m_c2*sin(theta_b2_b1),                                                                                                                                 2*x_m_c2*cos(theta_b2_b1) - 2*x_m_c1 - 2*y_m_c2*sin(theta_b2_b1),                0,                0, 0, 0,                                                                                                                                                                                                                                                                   z_m_c2*(2*qz_c_b*cos(theta_b2_b1) + 2*qy_c_b*sin(theta_b2_b1)) - y_m_c2*(2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1)) - x_m_c2*(2*qx_c_b*cos(theta_b2_b1) + 2*qw_c_b*sin(theta_b2_b1)), -2*qw_c_b, 2*qx_c_b,  2*qy_c_b,                                                               2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1),                                                             - 2*qx_c_b*cos(theta_b2_b1) - 2*qw_c_b*sin(theta_b2_b1),                                                                                     2*qz_c_b*sin(theta_b2_b1) - 2*qy_c_b*cos(theta_b2_b1);...
                                                                                                                                                                                                0,                                                                                                                                                                                                0,                                                                                                                                                                                                0,                                                                                                                                                                                                0,                0,                0, 0, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                   sin(theta_b2_b1),         0,        0,         0,                                                                                                                   0,                                                                                                                   0,                                                                                                                                         0;...
                                                                                                                                                                                                0,                                                                                                                                                                                                0,                                                                                                                                                                                                0,                                                                                                                                                                                                0,                0,                0, 0, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                   cos(theta_b2_b1),         0,        0,         0,                                                                                                                   0,                                                                                                                   0,                                                                                                                                         0;...
                                                                                                                                                                                                0,                                                                                                                                                                                                0,                                                                                                                                                                                                0,                                                                                                                                                                                                0,                0,                0, 0, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                  0,         0,        0,         0,                                                                                                                   0,                                                                                                                   0,                                                                                                                                         0;...
                                                                                                                                                                                                0,                                                                                                                                                                                                0,                                                                                                                                                                                                0,                                                                                                                                                                                                0,                0,                0, 0, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                  0,         0,        0,         0,                                                                                                                   0,                                                                                                                   0,                                                                                                                                         0;...
 y_m_c2*(2*qx_c_b*cos(theta_b2_b1) + 2*qw_c_b*sin(theta_b2_b1)) - x_m_c2*(2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1)) + z_m_c2*(2*qy_c_b*cos(theta_b2_b1) - 2*qz_c_b*sin(theta_b2_b1)), x_m_c2*(2*qz_c_b*cos(theta_b2_b1) + 2*qy_c_b*sin(theta_b2_b1)) - y_m_c2*(2*qy_c_b*cos(theta_b2_b1) - 2*qz_c_b*sin(theta_b2_b1)) + z_m_c2*(2*qx_c_b*cos(theta_b2_b1) + 2*qw_c_b*sin(theta_b2_b1)), x_m_c2*(2*qy_c_b*cos(theta_b2_b1) - 2*qz_c_b*sin(theta_b2_b1)) + y_m_c2*(2*qz_c_b*cos(theta_b2_b1) + 2*qy_c_b*sin(theta_b2_b1)) + z_m_c2*(2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1)), z_m_c2*(2*qz_c_b*cos(theta_b2_b1) + 2*qy_c_b*sin(theta_b2_b1)) - y_m_c2*(2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1)) - x_m_c2*(2*qx_c_b*cos(theta_b2_b1) + 2*qw_c_b*sin(theta_b2_b1)), sin(theta_b2_b1), cos(theta_b2_b1), 0, 0, x_c_b*cos(theta_b2_b1) - y_c_b*sin(theta_b2_b1) - z_m_c2*(2*qx_c_b*qz_c_b*cos(theta_b2_b1) - 2*qw_c_b*qy_c_b*cos(theta_b2_b1) + 2*qw_c_b*qz_c_b*sin(theta_b2_b1) + 2*qx_c_b*qy_c_b*sin(theta_b2_b1)) + x_m_c2*(sin(theta_b2_b1)*(2*qw_c_b*qx_c_b - 2*qy_c_b*qz_c_b) - cos(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 - qy_c_b^2 + qz_c_b^2)) + y_m_c2*(cos(theta_b2_b1)*(2*qw_c_b*qx_c_b + 2*qy_c_b*qz_c_b) + sin(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 + qy_c_b^2 - qz_c_b^2)),         0,        0,         0, - 2*cos(theta_b2_b1)*(qw_c_b*qx_c_b - qy_c_b*qz_c_b) - sin(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 - qy_c_b^2 + qz_c_b^2), sin(theta_b2_b1)*(2*qw_c_b*qx_c_b + 2*qy_c_b*qz_c_b) - cos(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 + qy_c_b^2 - qz_c_b^2), 2*qw_c_b*qz_c_b*cos(theta_b2_b1) + 2*qx_c_b*qy_c_b*cos(theta_b2_b1) + 2*qw_c_b*qy_c_b*sin(theta_b2_b1) - 2*qx_c_b*qz_c_b*sin(theta_b2_b1);...
                                                                                                                                                                                         2*qx_c_b,                                                                                                                                                                                         2*qy_c_b,                                                                                                                                                                                        -2*qz_c_b,                                                                                                                                                                                        -2*qw_c_b,                0,                0, 0, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                  0,         0,        0,         0,                                                                                                                   0,                                                                                                                   0,                                                                                                                                         0;...
                                                                                                                                                                                         2*qw_c_b,                                                                                                                                                                                         2*qz_c_b,                                                                                                                                                                                         2*qy_c_b,                                                                                                                                                                                         2*qx_c_b,                0,                0, 0, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                  0,         0,        0,         0,                                                                                                                   0,                                                                                                                   0,                                                                                                                                         0;...
                                                                                                                                                                                        -2*qz_c_b,                                                                                                                                                                                         2*qw_c_b,                                                                                                                                                                                        -2*qx_c_b,                                                                                                                                                                                         2*qy_c_b,                0,                0, 0, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                  0,         0,        0,         0,                                                                                                                   0,                                                                                                                   0,                                                                                                                                         0;...
                                                                                                                                          - 2*qx_c_b*cos(theta_b2_b1) - 2*qw_c_b*sin(theta_b2_b1),                                                                                                                                            2*qz_c_b*sin(theta_b2_b1) - 2*qy_c_b*cos(theta_b2_b1),                                                                                                                                            2*qz_c_b*cos(theta_b2_b1) + 2*qy_c_b*sin(theta_b2_b1),                                                                                                                                            2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1),                0,                0, 0, 0,                                                                                                                                                                                                                                                                                                                                                - 2*cos(theta_b2_b1)*(qw_c_b*qx_c_b - qy_c_b*qz_c_b) - sin(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 - qy_c_b^2 + qz_c_b^2),         0,        0,         0,                                                                                                                   0,                                                                                                                   0,                                                                                                                                         0;...
                                                                                                                                            2*qx_c_b*sin(theta_b2_b1) - 2*qw_c_b*cos(theta_b2_b1),                                                                                                                                          - 2*qz_c_b*cos(theta_b2_b1) - 2*qy_c_b*sin(theta_b2_b1),                                                                                                                                            2*qz_c_b*sin(theta_b2_b1) - 2*qy_c_b*cos(theta_b2_b1),                                                                                                                                          - 2*qx_c_b*cos(theta_b2_b1) - 2*qw_c_b*sin(theta_b2_b1),                0,                0, 0, 0,                                                                                                                                                                                                                                                                                                                                                sin(theta_b2_b1)*(2*qw_c_b*qx_c_b + 2*qy_c_b*qz_c_b) - cos(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 + qy_c_b^2 - qz_c_b^2),         0,        0,         0,                                                                                                                   0,                                                                                                                   0,                                                                                                                                         0;...
                                                                                                                                            2*qz_c_b*cos(theta_b2_b1) + 2*qy_c_b*sin(theta_b2_b1),                                                                                                                                            2*qx_c_b*sin(theta_b2_b1) - 2*qw_c_b*cos(theta_b2_b1),                                                                                                                                            2*qx_c_b*cos(theta_b2_b1) + 2*qw_c_b*sin(theta_b2_b1),                                                                                                                                            2*qz_c_b*sin(theta_b2_b1) - 2*qy_c_b*cos(theta_b2_b1),                0,                0, 0, 0,                                                                                                                                                                                                                                                                                                                          2*qw_c_b*qz_c_b*cos(theta_b2_b1) + 2*qx_c_b*qy_c_b*cos(theta_b2_b1) + 2*qw_c_b*qy_c_b*sin(theta_b2_b1) - 2*qx_c_b*qz_c_b*sin(theta_b2_b1),         0,        0,         0,                                                                                                                   0,                                                                                                                   0,                                                                                                                                         0];

% Jacobian
J1 = [ 2*qx_c_b*x_m_c1 + 2*qw_c_b*y_m_c1 - 2*qz_c_b*z_m_c1 - x_m_c2*(2*qx_c_b*cos(theta_b2_b1) + 2*qw_c_b*sin(theta_b2_b1)) - y_m_c2*(2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1)) + z_m_c2*(2*qz_c_b*cos(theta_b2_b1) + 2*qy_c_b*sin(theta_b2_b1)), 2*qy_c_b*x_m_c1 + 2*qz_c_b*y_m_c1 + 2*qw_c_b*z_m_c1 - x_m_c2*(2*qy_c_b*cos(theta_b2_b1) - 2*qz_c_b*sin(theta_b2_b1)) - y_m_c2*(2*qz_c_b*cos(theta_b2_b1) + 2*qy_c_b*sin(theta_b2_b1)) - z_m_c2*(2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1)), 2*qy_c_b*y_m_c1 - 2*qz_c_b*x_m_c1 - 2*qx_c_b*z_m_c1 + x_m_c2*(2*qz_c_b*cos(theta_b2_b1) + 2*qy_c_b*sin(theta_b2_b1)) - y_m_c2*(2*qy_c_b*cos(theta_b2_b1) - 2*qz_c_b*sin(theta_b2_b1)) + z_m_c2*(2*qx_c_b*cos(theta_b2_b1) + 2*qw_c_b*sin(theta_b2_b1)), 2*qx_c_b*y_m_c1 - 2*qw_c_b*x_m_c1 + 2*qy_c_b*z_m_c1 + x_m_c2*(2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1)) - y_m_c2*(2*qx_c_b*cos(theta_b2_b1) + 2*qw_c_b*sin(theta_b2_b1)) - z_m_c2*(2*qy_c_b*cos(theta_b2_b1) - 2*qz_c_b*sin(theta_b2_b1)), 1 - cos(theta_b2_b1), sin(theta_b2_b1), -1, 0, y_c_b*cos(theta_b2_b1) + x_c_b*sin(theta_b2_b1) + z_m_c2*(2*qw_c_b*qz_c_b*cos(theta_b2_b1) + 2*qx_c_b*qy_c_b*cos(theta_b2_b1) + 2*qw_c_b*qy_c_b*sin(theta_b2_b1) - 2*qx_c_b*qz_c_b*sin(theta_b2_b1)) - x_m_c2*(cos(theta_b2_b1)*(2*qw_c_b*qx_c_b - 2*qy_c_b*qz_c_b) + sin(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 - qy_c_b^2 + qz_c_b^2)) + y_m_c2*(sin(theta_b2_b1)*(2*qw_c_b*qx_c_b + 2*qy_c_b*qz_c_b) - cos(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 + qy_c_b^2 - qz_c_b^2)), - qw_c_b^2 + qx_c_b^2 + qy_c_b^2 - qz_c_b^2, 2*qw_c_b*qx_c_b + 2*qy_c_b*qz_c_b, 2*qw_c_b*qy_c_b - 2*qx_c_b*qz_c_b, cos(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 - qy_c_b^2 + qz_c_b^2) - 2*sin(theta_b2_b1)*(qw_c_b*qx_c_b - qy_c_b*qz_c_b), - cos(theta_b2_b1)*(2*qw_c_b*qx_c_b + 2*qy_c_b*qz_c_b) - sin(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 + qy_c_b^2 - qz_c_b^2), 2*qx_c_b*qz_c_b*cos(theta_b2_b1) - 2*qw_c_b*qy_c_b*cos(theta_b2_b1) + 2*qw_c_b*qz_c_b*sin(theta_b2_b1) + 2*qx_c_b*qy_c_b*sin(theta_b2_b1)];
% transform from mu_x to mu_x_dt
J1 = J1*J_mu_x;
H1 = J_mu_x.'*H1*J_mu_x;

%% for z2
% Hessian
H2 = ...
[                                                                                                                                 2*y_m_c1 - 2*y_m_c2*cos(theta_b2_b1) - 2*x_m_c2*sin(theta_b2_b1),                                                                                                                                                               2*z_m_c1 - 2*z_m_c2*cos(theta_b2_b1),                                                                                                                                                                        2*z_m_c2*sin(theta_b2_b1),                                                                                                                                 2*x_m_c2*cos(theta_b2_b1) - 2*x_m_c1 - 2*y_m_c2*sin(theta_b2_b1),                 0,                0, 0, 0,                                                                                                                                                                                                                                                                   z_m_c2*(2*qz_c_b*cos(theta_b2_b1) + 2*qy_c_b*sin(theta_b2_b1)) - y_m_c2*(2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1)) - x_m_c2*(2*qx_c_b*cos(theta_b2_b1) + 2*qw_c_b*sin(theta_b2_b1)), -2*qw_c_b,  2*qx_c_b, 2*qy_c_b,                                                             2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1),                                                               - 2*qx_c_b*cos(theta_b2_b1) - 2*qw_c_b*sin(theta_b2_b1),                                                                                     2*qz_c_b*sin(theta_b2_b1) - 2*qy_c_b*cos(theta_b2_b1);...
                                                                                                                                                             2*z_m_c1 - 2*z_m_c2*cos(theta_b2_b1),                                                                                                                                   2*y_m_c2*cos(theta_b2_b1) - 2*y_m_c1 - 2*x_m_c2*sin(theta_b2_b1),                                                                                                                                 2*x_m_c1 - 2*x_m_c2*cos(theta_b2_b1) - 2*y_m_c2*sin(theta_b2_b1),                                                                                                                                                                       -2*z_m_c2*sin(theta_b2_b1),                 0,                0, 0, 0,                                                                                                                                                                                                                                                                 - x_m_c2*(2*qy_c_b*cos(theta_b2_b1) - 2*qz_c_b*sin(theta_b2_b1)) - y_m_c2*(2*qz_c_b*cos(theta_b2_b1) + 2*qy_c_b*sin(theta_b2_b1)) - z_m_c2*(2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1)),  2*qz_c_b, -2*qy_c_b, 2*qx_c_b,                                                           - 2*qz_c_b*cos(theta_b2_b1) - 2*qy_c_b*sin(theta_b2_b1),                                                                 2*qy_c_b*cos(theta_b2_b1) - 2*qz_c_b*sin(theta_b2_b1),                                                                                   - 2*qx_c_b*cos(theta_b2_b1) - 2*qw_c_b*sin(theta_b2_b1);...
                                                                                                                                                                        2*z_m_c2*sin(theta_b2_b1),                                                                                                                                   2*x_m_c1 - 2*x_m_c2*cos(theta_b2_b1) - 2*y_m_c2*sin(theta_b2_b1),                                                                                                                                 2*y_m_c1 - 2*y_m_c2*cos(theta_b2_b1) + 2*x_m_c2*sin(theta_b2_b1),                                                                                                                                                             2*z_m_c1 - 2*z_m_c2*cos(theta_b2_b1),                 0,                0, 0, 0,                                                                                                                                                                                                                                                                   x_m_c2*(2*qz_c_b*cos(theta_b2_b1) + 2*qy_c_b*sin(theta_b2_b1)) - y_m_c2*(2*qy_c_b*cos(theta_b2_b1) - 2*qz_c_b*sin(theta_b2_b1)) + z_m_c2*(2*qx_c_b*cos(theta_b2_b1) + 2*qw_c_b*sin(theta_b2_b1)),  2*qy_c_b,  2*qz_c_b, 2*qw_c_b,                                                             2*qz_c_b*sin(theta_b2_b1) - 2*qy_c_b*cos(theta_b2_b1),                                                               - 2*qz_c_b*cos(theta_b2_b1) - 2*qy_c_b*sin(theta_b2_b1),                                                                                     2*qx_c_b*sin(theta_b2_b1) - 2*qw_c_b*cos(theta_b2_b1);...
                                                                                                                                 2*x_m_c2*cos(theta_b2_b1) - 2*x_m_c1 - 2*y_m_c2*sin(theta_b2_b1),                                                                                                                                                                         -2*z_m_c2*sin(theta_b2_b1),                                                                                                                                                             2*z_m_c1 - 2*z_m_c2*cos(theta_b2_b1),                                                                                                                                 2*y_m_c2*cos(theta_b2_b1) - 2*y_m_c1 + 2*x_m_c2*sin(theta_b2_b1),                 0,                0, 0, 0,                                                                                                                                                                                                                                                                   x_m_c2*(2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1)) - y_m_c2*(2*qx_c_b*cos(theta_b2_b1) + 2*qw_c_b*sin(theta_b2_b1)) - z_m_c2*(2*qy_c_b*cos(theta_b2_b1) - 2*qz_c_b*sin(theta_b2_b1)), -2*qx_c_b, -2*qw_c_b, 2*qz_c_b,                                                             2*qx_c_b*cos(theta_b2_b1) + 2*qw_c_b*sin(theta_b2_b1),                                                                 2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1),                                                                                   - 2*qz_c_b*cos(theta_b2_b1) - 2*qy_c_b*sin(theta_b2_b1);...
                                                                                                                                                                                                0,                                                                                                                                                                                                  0,                                                                                                                                                                                                0,                                                                                                                                                                                                0,                 0,                0, 0, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                  -cos(theta_b2_b1),         0,         0,        0,                                                                                                                 0,                                                                                                                     0,                                                                                                                                         0;...
                                                                                                                                                                                                0,                                                                                                                                                                                                  0,                                                                                                                                                                                                0,                                                                                                                                                                                                0,                 0,                0, 0, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                   sin(theta_b2_b1),         0,         0,        0,                                                                                                                 0,                                                                                                                     0,                                                                                                                                         0;...
                                                                                                                                                                                                0,                                                                                                                                                                                                  0,                                                                                                                                                                                                0,                                                                                                                                                                                                0,                 0,                0, 0, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                  0,         0,         0,        0,                                                                                                                 0,                                                                                                                     0,                                                                                                                                         0;...
                                                                                                                                                                                                0,                                                                                                                                                                                                  0,                                                                                                                                                                                                0,                                                                                                                                                                                                0,                 0,                0, 0, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                  0,         0,         0,        0,                                                                                                                 0,                                                                                                                     0,                                                                                                                                         0;...
 z_m_c2*(2*qz_c_b*cos(theta_b2_b1) + 2*qy_c_b*sin(theta_b2_b1)) - y_m_c2*(2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1)) - x_m_c2*(2*qx_c_b*cos(theta_b2_b1) + 2*qw_c_b*sin(theta_b2_b1)), - x_m_c2*(2*qy_c_b*cos(theta_b2_b1) - 2*qz_c_b*sin(theta_b2_b1)) - y_m_c2*(2*qz_c_b*cos(theta_b2_b1) + 2*qy_c_b*sin(theta_b2_b1)) - z_m_c2*(2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1)), x_m_c2*(2*qz_c_b*cos(theta_b2_b1) + 2*qy_c_b*sin(theta_b2_b1)) - y_m_c2*(2*qy_c_b*cos(theta_b2_b1) - 2*qz_c_b*sin(theta_b2_b1)) + z_m_c2*(2*qx_c_b*cos(theta_b2_b1) + 2*qw_c_b*sin(theta_b2_b1)), x_m_c2*(2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1)) - y_m_c2*(2*qx_c_b*cos(theta_b2_b1) + 2*qw_c_b*sin(theta_b2_b1)) - z_m_c2*(2*qy_c_b*cos(theta_b2_b1) - 2*qz_c_b*sin(theta_b2_b1)), -cos(theta_b2_b1), sin(theta_b2_b1), 0, 0, y_c_b*cos(theta_b2_b1) + x_c_b*sin(theta_b2_b1) + z_m_c2*(2*qw_c_b*qz_c_b*cos(theta_b2_b1) + 2*qx_c_b*qy_c_b*cos(theta_b2_b1) + 2*qw_c_b*qy_c_b*sin(theta_b2_b1) - 2*qx_c_b*qz_c_b*sin(theta_b2_b1)) - x_m_c2*(cos(theta_b2_b1)*(2*qw_c_b*qx_c_b - 2*qy_c_b*qz_c_b) + sin(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 - qy_c_b^2 + qz_c_b^2)) + y_m_c2*(sin(theta_b2_b1)*(2*qw_c_b*qx_c_b + 2*qy_c_b*qz_c_b) - cos(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 + qy_c_b^2 - qz_c_b^2)),         0,         0,        0, cos(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 - qy_c_b^2 + qz_c_b^2) - 2*sin(theta_b2_b1)*(qw_c_b*qx_c_b - qy_c_b*qz_c_b), - cos(theta_b2_b1)*(2*qw_c_b*qx_c_b + 2*qy_c_b*qz_c_b) - sin(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 + qy_c_b^2 - qz_c_b^2), 2*qx_c_b*qz_c_b*cos(theta_b2_b1) - 2*qw_c_b*qy_c_b*cos(theta_b2_b1) + 2*qw_c_b*qz_c_b*sin(theta_b2_b1) + 2*qx_c_b*qy_c_b*sin(theta_b2_b1);...
                                                                                                                                                                                        -2*qw_c_b,                                                                                                                                                                                           2*qz_c_b,                                                                                                                                                                                         2*qy_c_b,                                                                                                                                                                                        -2*qx_c_b,                 0,                0, 0, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                  0,         0,         0,        0,                                                                                                                 0,                                                                                                                     0,                                                                                                                                         0;...
                                                                                                                                                                                         2*qx_c_b,                                                                                                                                                                                          -2*qy_c_b,                                                                                                                                                                                         2*qz_c_b,                                                                                                                                                                                        -2*qw_c_b,                 0,                0, 0, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                  0,         0,         0,        0,                                                                                                                 0,                                                                                                                     0,                                                                                                                                         0;...
                                                                                                                                                                                         2*qy_c_b,                                                                                                                                                                                           2*qx_c_b,                                                                                                                                                                                         2*qw_c_b,                                                                                                                                                                                         2*qz_c_b,                 0,                0, 0, 0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                  0,         0,         0,        0,                                                                                                                 0,                                                                                                                     0,                                                                                                                                         0;...
                                                                                                                                            2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1),                                                                                                                                            - 2*qz_c_b*cos(theta_b2_b1) - 2*qy_c_b*sin(theta_b2_b1),                                                                                                                                            2*qz_c_b*sin(theta_b2_b1) - 2*qy_c_b*cos(theta_b2_b1),                                                                                                                                            2*qx_c_b*cos(theta_b2_b1) + 2*qw_c_b*sin(theta_b2_b1),                 0,                0, 0, 0,                                                                                                                                                                                                                                                                                                                                                  cos(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 - qy_c_b^2 + qz_c_b^2) - 2*sin(theta_b2_b1)*(qw_c_b*qx_c_b - qy_c_b*qz_c_b),         0,         0,        0,                                                                                                                 0,                                                                                                                     0,                                                                                                                                         0;...
                                                                                                                                          - 2*qx_c_b*cos(theta_b2_b1) - 2*qw_c_b*sin(theta_b2_b1),                                                                                                                                              2*qy_c_b*cos(theta_b2_b1) - 2*qz_c_b*sin(theta_b2_b1),                                                                                                                                          - 2*qz_c_b*cos(theta_b2_b1) - 2*qy_c_b*sin(theta_b2_b1),                                                                                                                                            2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1),                 0,                0, 0, 0,                                                                                                                                                                                                                                                                                                                                              - cos(theta_b2_b1)*(2*qw_c_b*qx_c_b + 2*qy_c_b*qz_c_b) - sin(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 + qy_c_b^2 - qz_c_b^2),         0,         0,        0,                                                                                                                 0,                                                                                                                     0,                                                                                                                                         0;...
                                                                                                                                            2*qz_c_b*sin(theta_b2_b1) - 2*qy_c_b*cos(theta_b2_b1),                                                                                                                                            - 2*qx_c_b*cos(theta_b2_b1) - 2*qw_c_b*sin(theta_b2_b1),                                                                                                                                            2*qx_c_b*sin(theta_b2_b1) - 2*qw_c_b*cos(theta_b2_b1),                                                                                                                                          - 2*qz_c_b*cos(theta_b2_b1) - 2*qy_c_b*sin(theta_b2_b1),                 0,                0, 0, 0,                                                                                                                                                                                                                                                                                                                          2*qx_c_b*qz_c_b*cos(theta_b2_b1) - 2*qw_c_b*qy_c_b*cos(theta_b2_b1) + 2*qw_c_b*qz_c_b*sin(theta_b2_b1) + 2*qx_c_b*qy_c_b*sin(theta_b2_b1),         0,         0,        0,                                                                                                                 0,                                                                                                                     0,                                                                                                                                         0];

% Jacobian
J2 = [ 2*qx_c_b*y_m_c1 - 2*qw_c_b*x_m_c1 + 2*qy_c_b*z_m_c1 + x_m_c2*(2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1)) - y_m_c2*(2*qx_c_b*cos(theta_b2_b1) + 2*qw_c_b*sin(theta_b2_b1)) - z_m_c2*(2*qy_c_b*cos(theta_b2_b1) - 2*qz_c_b*sin(theta_b2_b1)), 2*qz_c_b*x_m_c1 - 2*qy_c_b*y_m_c1 + 2*qx_c_b*z_m_c1 - x_m_c2*(2*qz_c_b*cos(theta_b2_b1) + 2*qy_c_b*sin(theta_b2_b1)) + y_m_c2*(2*qy_c_b*cos(theta_b2_b1) - 2*qz_c_b*sin(theta_b2_b1)) - z_m_c2*(2*qx_c_b*cos(theta_b2_b1) + 2*qw_c_b*sin(theta_b2_b1)), 2*qy_c_b*x_m_c1 + 2*qz_c_b*y_m_c1 + 2*qw_c_b*z_m_c1 - x_m_c2*(2*qy_c_b*cos(theta_b2_b1) - 2*qz_c_b*sin(theta_b2_b1)) - y_m_c2*(2*qz_c_b*cos(theta_b2_b1) + 2*qy_c_b*sin(theta_b2_b1)) - z_m_c2*(2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1)), 2*qz_c_b*z_m_c1 - 2*qw_c_b*y_m_c1 - 2*qx_c_b*x_m_c1 + x_m_c2*(2*qx_c_b*cos(theta_b2_b1) + 2*qw_c_b*sin(theta_b2_b1)) + y_m_c2*(2*qw_c_b*cos(theta_b2_b1) - 2*qx_c_b*sin(theta_b2_b1)) - z_m_c2*(2*qz_c_b*cos(theta_b2_b1) + 2*qy_c_b*sin(theta_b2_b1)), -sin(theta_b2_b1), 1 - cos(theta_b2_b1), 0, -1, y_c_b*sin(theta_b2_b1) - x_c_b*cos(theta_b2_b1) + z_m_c2*(2*qx_c_b*qz_c_b*cos(theta_b2_b1) - 2*qw_c_b*qy_c_b*cos(theta_b2_b1) + 2*qw_c_b*qz_c_b*sin(theta_b2_b1) + 2*qx_c_b*qy_c_b*sin(theta_b2_b1)) - x_m_c2*(sin(theta_b2_b1)*(2*qw_c_b*qx_c_b - 2*qy_c_b*qz_c_b) - cos(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 - qy_c_b^2 + qz_c_b^2)) - y_m_c2*(cos(theta_b2_b1)*(2*qw_c_b*qx_c_b + 2*qy_c_b*qz_c_b) + sin(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 + qy_c_b^2 - qz_c_b^2)), 2*qy_c_b*qz_c_b - 2*qw_c_b*qx_c_b, - qw_c_b^2 + qx_c_b^2 - qy_c_b^2 + qz_c_b^2, 2*qw_c_b*qz_c_b + 2*qx_c_b*qy_c_b, cos(theta_b2_b1)*(2*qw_c_b*qx_c_b - 2*qy_c_b*qz_c_b) + sin(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 - qy_c_b^2 + qz_c_b^2), cos(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 + qy_c_b^2 - qz_c_b^2) - sin(theta_b2_b1)*(2*qw_c_b*qx_c_b + 2*qy_c_b*qz_c_b), 2*qx_c_b*qz_c_b*sin(theta_b2_b1) - 2*qx_c_b*qy_c_b*cos(theta_b2_b1) - 2*qw_c_b*qy_c_b*sin(theta_b2_b1) - 2*qw_c_b*qz_c_b*cos(theta_b2_b1)];
% transform from mu_x to mu_x_dt
J2 = J2*J_mu_x;
H2 = J_mu_x.'*H2*J_mu_x;

%% for z3
% Hessian
H3 = ...
[ 2*z_m_c1 - 2*z_m_c2, 2*y_m_c2 - 2*y_m_c1, 2*x_m_c1 - 2*x_m_c2,                   0, 0, 0, 0, 0, 0, 2*qz_c_b, -2*qy_c_b,  2*qx_c_b, -2*qz_c_b,  2*qy_c_b, -2*qx_c_b;...
 2*y_m_c2 - 2*y_m_c1, 2*z_m_c2 - 2*z_m_c1,                   0, 2*x_m_c1 - 2*x_m_c2, 0, 0, 0, 0, 0, 2*qw_c_b, -2*qx_c_b, -2*qy_c_b, -2*qw_c_b,  2*qx_c_b,  2*qy_c_b;...
 2*x_m_c1 - 2*x_m_c2,                   0, 2*z_m_c2 - 2*z_m_c1, 2*y_m_c1 - 2*y_m_c2, 0, 0, 0, 0, 0, 2*qx_c_b,  2*qw_c_b, -2*qz_c_b, -2*qx_c_b, -2*qw_c_b,  2*qz_c_b;...
                   0, 2*x_m_c1 - 2*x_m_c2, 2*y_m_c1 - 2*y_m_c2, 2*z_m_c1 - 2*z_m_c2, 0, 0, 0, 0, 0, 2*qy_c_b,  2*qz_c_b,  2*qw_c_b, -2*qy_c_b, -2*qz_c_b, -2*qw_c_b;...
                   0,                   0,                   0,                   0, 0, 0, 0, 0, 0,        0,         0,         0,         0,         0,         0;...
                   0,                   0,                   0,                   0, 0, 0, 0, 0, 0,        0,         0,         0,         0,         0,         0;...
                   0,                   0,                   0,                   0, 0, 0, 0, 0, 0,        0,         0,         0,         0,         0,         0;...
                   0,                   0,                   0,                   0, 0, 0, 0, 0, 0,        0,         0,         0,         0,         0,         0;...
                   0,                   0,                   0,                   0, 0, 0, 0, 0, 0,        0,         0,         0,         0,         0,         0;...
            2*qz_c_b,            2*qw_c_b,            2*qx_c_b,            2*qy_c_b, 0, 0, 0, 0, 0,        0,         0,         0,         0,         0,         0;...
           -2*qy_c_b,           -2*qx_c_b,            2*qw_c_b,            2*qz_c_b, 0, 0, 0, 0, 0,        0,         0,         0,         0,         0,         0;...
            2*qx_c_b,           -2*qy_c_b,           -2*qz_c_b,            2*qw_c_b, 0, 0, 0, 0, 0,        0,         0,         0,         0,         0,         0;...
           -2*qz_c_b,           -2*qw_c_b,           -2*qx_c_b,           -2*qy_c_b, 0, 0, 0, 0, 0,        0,         0,         0,         0,         0,         0;...
            2*qy_c_b,            2*qx_c_b,           -2*qw_c_b,           -2*qz_c_b, 0, 0, 0, 0, 0,        0,         0,         0,         0,         0,         0;...
           -2*qx_c_b,            2*qy_c_b,            2*qz_c_b,           -2*qw_c_b, 0, 0, 0, 0, 0,        0,         0,         0,         0,         0,         0];
    
% Jacobian
J3 = [ 2*qz_c_b*x_m_c1 - 2*qz_c_b*x_m_c2 - 2*qy_c_b*y_m_c1 + 2*qy_c_b*y_m_c2 + 2*qx_c_b*z_m_c1 - 2*qx_c_b*z_m_c2, 2*qw_c_b*x_m_c1 - 2*qw_c_b*x_m_c2 - 2*qx_c_b*y_m_c1 + 2*qx_c_b*y_m_c2 - 2*qy_c_b*z_m_c1 + 2*qy_c_b*z_m_c2, 2*qx_c_b*x_m_c1 - 2*qx_c_b*x_m_c2 + 2*qw_c_b*y_m_c1 - 2*qw_c_b*y_m_c2 - 2*qz_c_b*z_m_c1 + 2*qz_c_b*z_m_c2, 2*qy_c_b*x_m_c1 - 2*qy_c_b*x_m_c2 + 2*qz_c_b*y_m_c1 - 2*qz_c_b*y_m_c2 + 2*qw_c_b*z_m_c1 - 2*qw_c_b*z_m_c2, 0, 0, 0, 0, 0, 2*qw_c_b*qy_c_b + 2*qx_c_b*qz_c_b, 2*qw_c_b*qz_c_b - 2*qx_c_b*qy_c_b, qw_c_b^2 + qx_c_b^2 - qy_c_b^2 - qz_c_b^2, - 2*qw_c_b*qy_c_b - 2*qx_c_b*qz_c_b, 2*qx_c_b*qy_c_b - 2*qw_c_b*qz_c_b, - qw_c_b^2 - qx_c_b^2 + qy_c_b^2 + qz_c_b^2];
% transform from mu_x to mu_x_dt
J3 = J3*J_mu_x;
H3 = J_mu_x.'*H3*J_mu_x;

%% for z4
% Hessian
H4 = zeros(15,15);
H4(1:4,1:4) = 2*eye(4);
J4 = zeros(1,15);
J4(1,1:4) = [ 2*qx_c_b, 2*qy_c_b, 2*qz_c_b, 2*qw_c_b ];
% transform from mu_x to mu_x_dt
J4 = J4*J_mu_x;
H4 = J_mu_x.'*H4*J_mu_x;

%% combine z1:z4
mat_Jacobian = [J1; J2; J3; J4];
cellmat_Hessian = {H1; H2; H3; H4};
vec_Cost = [x_c_b - x_b2_b1 - x_m_c1*(qw_c_b^2 - qx_c_b^2 - qy_c_b^2 + qz_c_b^2) - x_c_b*cos(theta_b2_b1) + y_m_c1*(2*qw_c_b*qx_c_b + 2*qy_c_b*qz_c_b) + z_m_c1*(2*qw_c_b*qy_c_b - 2*qx_c_b*qz_c_b) + y_c_b*sin(theta_b2_b1) + z_m_c2*(2*qx_c_b*qz_c_b*cos(theta_b2_b1) - 2*qw_c_b*qy_c_b*cos(theta_b2_b1) + 2*qw_c_b*qz_c_b*sin(theta_b2_b1) + 2*qx_c_b*qy_c_b*sin(theta_b2_b1)) - x_m_c2*(sin(theta_b2_b1)*(2*qw_c_b*qx_c_b - 2*qy_c_b*qz_c_b) - cos(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 - qy_c_b^2 + qz_c_b^2)) - y_m_c2*(cos(theta_b2_b1)*(2*qw_c_b*qx_c_b + 2*qy_c_b*qz_c_b) + sin(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 + qy_c_b^2 - qz_c_b^2));...
    y_c_b - y_b2_b1 - y_m_c1*(qw_c_b^2 - qx_c_b^2 + qy_c_b^2 - qz_c_b^2) - y_c_b*cos(theta_b2_b1) - 2*x_m_c1*(qw_c_b*qx_c_b - qy_c_b*qz_c_b) + z_m_c1*(2*qw_c_b*qz_c_b + 2*qx_c_b*qy_c_b) - x_c_b*sin(theta_b2_b1) - z_m_c2*(2*qw_c_b*qz_c_b*cos(theta_b2_b1) + 2*qx_c_b*qy_c_b*cos(theta_b2_b1) + 2*qw_c_b*qy_c_b*sin(theta_b2_b1) - 2*qx_c_b*qz_c_b*sin(theta_b2_b1)) + x_m_c2*(cos(theta_b2_b1)*(2*qw_c_b*qx_c_b - 2*qy_c_b*qz_c_b) + sin(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 - qy_c_b^2 + qz_c_b^2)) - y_m_c2*(sin(theta_b2_b1)*(2*qw_c_b*qx_c_b + 2*qy_c_b*qz_c_b) - cos(theta_b2_b1)*(qw_c_b^2 - qx_c_b^2 + qy_c_b^2 - qz_c_b^2));...
    qw_c_b^2*z_m_c1 - qw_c_b^2*z_m_c2 + qx_c_b^2*z_m_c1 - qx_c_b^2*z_m_c2 - qy_c_b^2*z_m_c1 + qy_c_b^2*z_m_c2 - qz_c_b^2*z_m_c1 + qz_c_b^2*z_m_c2 + 2*qw_c_b*qy_c_b*x_m_c1 - 2*qw_c_b*qy_c_b*x_m_c2 + 2*qx_c_b*qz_c_b*x_m_c1 - 2*qx_c_b*qz_c_b*x_m_c2 + 2*qw_c_b*qz_c_b*y_m_c1 - 2*qx_c_b*qy_c_b*y_m_c1 - 2*qw_c_b*qz_c_b*y_m_c2 + 2*qx_c_b*qy_c_b*y_m_c2;...
    qw_c_b^2 + qx_c_b^2 + qy_c_b^2 + qz_c_b^2 - 1];


end

